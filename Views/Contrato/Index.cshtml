@using inmobiliaria_mvc.ViewModels
@model TablaViewModel<Contrato>

@{
    ViewData["Title"] = "Contratos";
}

<h1>@ViewData["Title"]</h1>

@if (ViewBag.Mensaje != null)
{
    <div class="alert alert-success">@ViewBag.Mensaje</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<form asp-action="Index" method="get" class="mb-3">
    <div class="input-group">
        <input type="text" name="termino" class="form-control" placeholder="Buscar por dirección, precio o propietario"
            value="@ViewData["Termino"]" />
        <button type="submit" class="btn btn-primary">Buscar</button>
    </div>
</form>

<p>
    <a asp-action="Create" class="btn btn-success">Crear Nuevo Contrato</a>
</p>

@{
    var disponible = ViewData["Disponible"] as bool?;
    var opciones = new List<SelectListItem>
{
new SelectListItem { Text = "Todos", Value = "", Selected = disponible == null },
new SelectListItem { Text = "Contratos vigentes", Value = "true", Selected = disponible == true },
new SelectListItem { Text = "Contratos cancelados", Value = "false", Selected = disponible == false }
};
}

<!-- Filtros -->
<div class="row mb-3">
    <div class="col-md-4">
        <label>Disponibilidad</label>
        <select id="filtro-disponible" class="form-select">
            <option value="true" selected="@(disponible == true)">Vigentes</option>
            <option value="false" selected="@(disponible == false)">Cancelados</option>
            <option value="" selected="@(disponible == null)">-- Todos --</option>

        </select>
    </div>

    <div class="col-md-4">
        <label>Plazo (días)</label>
        <select id="filtro-plazo" class="form-select">
            <option value="">-- Todos --</option>
            <option value="30">30 días</option>
            <option value="60">60 días</option>
            <option value="90">90 días</option>
        </select>
    </div>

    <div class="col-md-4">
        <label>Plazo personalizado</label>
        <input type="number" id="filtro-plazo-custom" class="form-control" placeholder="Ej: 45">
    </div>
</div>

<div id="tabla-contratos">
    <partial name="_Tabla" model="Model" />
</div>

<script>
    function cargarTabla(page = 1) {
        const disponible = document.getElementById("filtro-disponible").value;
        const plazoSelect = document.getElementById("filtro-plazo").value;
        const plazoCustom = document.getElementById("filtro-plazo-custom").value;

        const plazo = plazoCustom || plazoSelect;

        const params = new URLSearchParams({
            page: page,
            disponible: disponible,
            plazo: plazo
        });

        fetch(`/Contrato/Filtrar?${params.toString()}`)
            .then(res => res.text())
            .then(html => {
                document.getElementById("tabla-contratos").innerHTML = html;
                attachEvents();
            });
    }

    function attachEvents() {
        document.querySelectorAll("#tabla-contratos .page-link[data-page]")?.forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                const page = this.getAttribute("data-page");
                cargarTabla(page);
            });
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("filtro-disponible").addEventListener("change", () => cargarTabla(1));
        document.getElementById("filtro-plazo").addEventListener("change", () => cargarTabla(1));
        document.getElementById("filtro-plazo-custom").addEventListener("input", () => cargarTabla(1));

        attachEvents();
    });
</script>