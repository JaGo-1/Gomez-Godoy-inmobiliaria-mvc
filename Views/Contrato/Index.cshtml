@using inmobiliaria_mvc.ViewModels
@model TablaViewModel<Contrato>

@{
    ViewData["Title"] = "Contratos";
}

<h1>@ViewData["Title"]</h1>

@if (ViewBag.Mensaje != null)
{
    <div class="alert alert-success">@ViewBag.Mensaje</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<form asp-action="Index" method="get" class="mb-3">
    <div class="input-group">
        <input type="text" name="termino" class="form-control" placeholder="Buscar por dirección, precio o propietario"
            value="@ViewData["Termino"]" />
        <button type="submit" class="btn btn-primary">Buscar</button>
    </div>
</form>

<p>
    <a asp-action="Create" class="btn btn-success">Crear Nuevo Contrato</a>
</p>
@{
    var disponible = ViewData["Disponible"] as bool?;
    var opciones = new List<SelectListItem>
{
new SelectListItem { Text = "Todos", Value = "", Selected = disponible == null },
new SelectListItem { Text = "Contratos vigentes", Value = "true", Selected = disponible == true },
new SelectListItem { Text = "Contratos cancelados", Value = "false", Selected = disponible == false }
};
}

<form asp-action="Index" method="get" class="mb-3">
    <div class="dropdown">
        <!-- Botón de Filtro -->
        <button class="btn btn-outline-secondary d-flex align-items-center dropdown-toggle px-3 py-2 gap-2  "
            type="button" id="dropdownFiltro" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa-solid fa-sliders"></i>
            Filtrar
        </button>

        <!-- Opciones -->
        <ul class="dropdown-menu border-1" aria-labelledby="dropdownFiltro">
            <li>
                <button type="submit" name="disponible" value=""
                    class="dropdown-item @(disponible == null ? "active fw-bold" : "")">
                    <i class="bi bi-list-check me-2"></i> Todos
                </button>
            </li>
            <li>
                <button type="submit" name="disponible" value="true"
                    class="dropdown-item @(disponible == true ? "active fw-bold" : "")">
                    <i class="bi bi-check-circle me-2 text-success"></i> Vigentes
                </button>
            </li>
            <li>
                <button type="submit" name="disponible" value="false"
                    class="dropdown-item @(disponible == false ? "active fw-bold" : "")">
                    <i class="bi bi-x-circle me-2 text-danger"></i> Cancelados
                </button>
            </li>
        </ul>
    </div>
</form>



<div id="tabla-contratos">
    <partial name="_Tabla" model="Model" />
</div>

<script>
    function cargarTabla(page = 1, disponible = "") {
        fetch(`/Contrato/Filtrar?page=${page}&disponible=${disponible}`)
            .then(res => res.text())
            .then(html => {
                document.getElementById("tabla-contratos").innerHTML = html;
                attachEvents();
            });
    }

    function attachEvents() {
        document.querySelector("#filtro-disponible select")?.addEventListener("change", function () {
            cargarTabla(1, this.value);
        });

        document.querySelectorAll("#tabla-contratos .page-link[data-page]")?.forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                const page = this.getAttribute("data-page");
                const disponible = document.querySelector("#filtro-disponible select")?.value || "";
                cargarTabla(page, disponible);
            });
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        attachEvents();
    });
</script>